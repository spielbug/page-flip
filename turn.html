<!--
 Page flip effect implemented using javascript and jquery
 I wanted page flipping effect for my app. turn.js seemed very best candidate, but unfortunately it didn't work
 for my project and it was difficult to hack. So I decided to develop my own script. It's not car with just key.
 it is just bundle of math but not so difficult. After looking at code, I want someone to continue add functionality
 to this simple source
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Turn js</title>
    <style>
        html, body
        {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        div {
            width:500px;height:500px;
            border:1px solid black;
            //overflow: hidden;
        }
        #fb {
            position:relative;
            background:silver;
            margin:auto;
            margin-top:100px;
        }
        .page {
            //position:absolute;
        }

    </style>
</head>
<body>

<div id="fb">
    <div class="page" id="page1" style="background: teal;">1</div>
    <div class="page" id="page2" style="background: gold;">2</div>
    <div class="page" id="page3" style="background: moccasin;">3</div>
    <div class="page" id="page4" style="background: darkcyan;">4</div>
</div>
</body>
<!-- you will need jquery somewhere -->
<script src="libs/jquery.js"></script>
<!-- you don't need this. just for test-->
<script src="libs/turn.js"></script>
<script>

    var _w, _h, _flipper, _left, _right;
    function make(container) {
        container = $(container)
        _w = container.width()
        _h = container.height()
        container.width(_w*2+5)
        container.css({
            position : 'relative'
        })

        // make side
        _left = makeDiv(_w, _h, 'left-side')
        _left.css({
            position:'relative',
            float:'left'
        })
        _right = makeDiv(_w, _h, 'right-side')
        _right.css({
            position:'relative',
            float:'left'
        })


        var childs = container.children()
        var len=childs.length
        for(var i = 0; i<len; i++) {
            var child = $(childs[len-i-1]) // access in reversed order
            // make wrapper
            var wrapper=$('<DIV>').addClass('fb-wrapper')
            wrapper.css({
                position : 'absolute'
            })
            _right.append(wrapper)
            child.detach();
            child.appendTo(wrapper)
            //wrapper.append(child)
            //console.log(child)
        }


        container.append(_left);
        container.append(_right);

        // div for flipping
        _flipper = makeDiv(_w, _h, 'flipper')
        _flipper.css({
            'position':'absolute',
            'overflow':'hidden'
        })
        container.append(_flipper)

        return 'done'
    }

    function makeDiv(w, h, id) {
        var div = $('<div>')
        div.attr('id', id)
        div.width(w)
        div.height(h)
        return div
    }
    function deg2rad(deg) {
        return deg/180*Math.PI
    }

    function rad2deg(rad) {
        return rad*180/Math.PI
    }

    function getRotatedSize(w, h, angle) {
        var x1 = -w/2
        var x2 = w/2
        var y1 = -h/2
        var y2 = h/2
        var w = Math.max(x2*Math.cos(angle)-y2*Math.sin(angle),
            x2*Math.cos(angle)-y1*Math.sin(angle))*2
        var h = Math.max(x1*Math.sin(angle)+y2*Math.cos(angle),
            x2*Math.sin(angle)+y2*Math.cos(angle))*2
        return {'w':w, 'h':h }
    }

    function reformFlipper(w, h, angle, distance) {
        var rs = getRotatedSize(w, h, angle)
        //_flipper.removeAttr('style');

        // limit distance
        var pageWidth = Math.abs(1/Math.cos(angle)*distance)
        //if(pageWidth>_w) distance =  _w * Math.abs(Math.cos(angle))

        var sidePosition = _right.position()
        _flipper.css({
            'left':(sidePosition.left-(rs.w-_w)/2),
            'top':(sidePosition.top-(rs.h-_h)/2)
        })
        _flipper.width(rs.w)
        _flipper.height(rs.h)
        _flipper.css({
            'transform':'rotateZ('+(angle)+'rad) translate('+(distance)+'px)',
            //'transform':'rotateZ('+rad2deg(angle)+'deg)',
        })

        reformDiv('#page1', rs.w, rs.h, -angle, distance)
        if(distance>0) reformFlippingDivLeft('#page2', rs.w, rs.h, -angle, distance)
        else reformFlippingDivRight('#page2', rs.w, rs.h, -angle, distance)
    }

    function reformDiv(div, dw, dh, angle, distance) {
        if(!div.fn) div = $(div)
        var top = (dh-_h)/2
        var left = (dw-_w)/2
        var wrapper = div.parent()
        wrapper.appendTo(_flipper)
        wrapper.css({
            'top':'0px',
            'left': '0px',
            'z-index':1,
            'transform':'translate('+(-distance+left)+'px, '+top+'px) rotateZ('+(angle)+'rad)'
            //'transform':'translate('+left+'px, '+top+'px) rotateZ('+rad2deg(angle)+'deg)',
        })
    }

    function reformFlippingDivLeft(div, rw, rh, angle, distance) {
        if(!div.fn) div = $(div)
        var topMargin = (rh-_h)/2

        var rcx = _w - (Math.cos(angle)*_w+distance)/Math.cos(angle)
        rcx = _w + rcx
        var rcy = 0
        var fdTop = -Math.tan(angle)*(Math.cos(angle)*_w-distance)
        var fdLeft = -rcx
console.log(distance, rcx, fdLeft, fdTop)
        if(angle>0) {
            fdTop = topMargin*2+fdTop
            rcy = _h;
        }

        var wrapper = div.parent()
        wrapper.appendTo(_flipper)
        wrapper.css({
            'z-index':2,
            'transform':'translate('+fdLeft+'px, '+fdTop+'px) rotateZ('+(-angle)+'rad)',
            'transform-origin':rcx+'px '+rcy+'px',
        })
    }

    function reformFlippingDivRight(div, rw, rh, angle, distance) {
        if(!div.fn) div = $(div)
        var topMargin = (rh-_h)/2

        var rcx = _w - (Math.cos(angle)*_w+distance)/Math.cos(angle)
        //var rcx = -distance
        var rcy = 0
        var fdTop = Math.tan(angle)*(Math.cos(angle)*_w+distance)
        var fdLeft = rw-rcx
console.log(distance, rcx, fdLeft)
        if(angle<0) {
            fdTop = topMargin*2+fdTop
            rcy = _h;
        }

        var wrapper = div.parent()
        wrapper.appendTo(_flipper)
        wrapper.css({
            'z-index':2,
            'transform':'translate('+fdLeft+'px, '+fdTop+'px) rotateZ('+(-angle)+'rad)',
            'transform-origin':rcx+'px '+rcy+'px',
        })
    }

    make('#fb')

    var startPoint=undefined;
    $('body').on('mousedown',function(ev){
        console.log(ev.pageX, ev.pageY)
        startPoint = {x:ev.pageX, y:ev.pageY}
    })
    $('body').on('mousemove',function(ev){
        if(startPoint) {
            var dx = ev.pageX-startPoint.x
            var dy = ev.pageY-startPoint.y
            var angle = -Math.atan2(dy, dx)
            var distance = Math.sqrt(dx*dx + dy*dy)
            reformFlipper(_w, _h, angle, distance)

        }

    })
    $('body').on('mouseup',function(ev) {
        startPoint = undefined
    })

</script>
</html>